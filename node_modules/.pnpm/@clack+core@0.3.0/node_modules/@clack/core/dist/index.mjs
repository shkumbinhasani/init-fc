import{cursor as h,erase as c}from"sisteransi";import{stdin as f,stdout as v}from"node:process";import*as a from"node:readline";import m from"node:readline";import{WriteStream as k}from"node:tty";import n from"picocolors";function x(o,t){if(o===t)return;const s=o.split(`
`),e=t.split(`
`),i=[];for(let r=0;r<Math.max(s.length,e.length);r++)s[r]!==e[r]&&i.push(r);return i}const d=Symbol("clack:cancel");function C(o){return o===d}function l(o,t){o.isTTY&&o.setRawMode(t)}const g=new Map([["k","up"],["j","down"],["h","left"],["l","right"]]),y=new Set(["up","down","left","right","space","enter"]);class u{constructor({render:t,input:s=f,output:e=v,...i},r=!0){this._track=!1,this._cursor=0,this.state="initial",this.error="",this.subscribers=new Map,this._prevFrame="",this.opts=i,this.onKeypress=this.onKeypress.bind(this),this.close=this.close.bind(this),this.render=this.render.bind(this),this._render=t.bind(this),this._track=r,this.input=s,this.output=e}prompt(){const t=new k(0);return t._write=(s,e,i)=>{this._track&&(this.value=this.rl.line.replace(/\t/g,""),this._cursor=this.rl.cursor,this.emit("value",this.value)),i()},this.input.pipe(t),this.rl=m.createInterface({input:this.input,output:t,tabSize:2,prompt:"",escapeCodeTimeout:50}),m.emitKeypressEvents(this.input,this.rl),this.rl.prompt(),this.opts.initialValue!==void 0&&this._track&&this.rl.write(this.opts.initialValue),this.input.on("keypress",this.onKeypress),l(this.input,!0),this.render(),new Promise((s,e)=>{this.once("submit",()=>{this.output.write(h.show),l(this.input,!1),s(this.value)}),this.once("cancel",()=>{this.output.write(h.show),l(this.input,!1),s(d)})})}on(t,s){const e=this.subscribers.get(t)??[];e.push({cb:s}),this.subscribers.set(t,e)}once(t,s){const e=this.subscribers.get(t)??[];e.push({cb:s,once:!0}),this.subscribers.set(t,e)}emit(t,...s){const e=this.subscribers.get(t)??[],i=[];for(const r of e)r.cb(...s),r.once&&i.push(()=>e.splice(e.indexOf(r),1));for(const r of i)r()}unsubscribe(){this.subscribers.clear()}onKeypress(t,s){if(this.state==="error"&&(this.state="active"),s?.name&&!this._track&&g.has(s.name)&&this.emit("cursor",g.get(s.name)),s?.name&&y.has(s.name)&&this.emit("cursor",s.name),t&&(t.toLowerCase()==="y"||t.toLowerCase()==="n")&&this.emit("confirm",t.toLowerCase()==="y"),t&&this.emit("key",t.toLowerCase()),s?.name==="return"){if(this.opts.validate){const e=this.opts.validate(this.value);e&&(this.error=e,this.state="error",this.rl.write(this.value))}this.state!=="error"&&(this.state="submit")}t===""&&(this.state="cancel"),(this.state==="submit"||this.state==="cancel")&&this.emit("finalize"),this.render(),(this.state==="submit"||this.state==="cancel")&&this.close()}close(){this.input.unpipe(),this.input.removeListener("keypress",this.onKeypress),this.output.write(`
`),l(this.input,!1),this.rl.close(),this.emit(`${this.state}`,this.value),this.unsubscribe()}restoreCursor(){const t=this._prevFrame.split(`
`).length-1;this.output.write(h.move(-999,t*-1))}render(){const t=this._render(this)??"";if(t!==this._prevFrame){if(this.state==="initial")this.output.write(h.hide);else{const s=x(this._prevFrame,t);if(this.restoreCursor(),s&&s?.length===1){const e=s[0];this.output.write(h.move(0,e)),this.output.write(c.lines(1));const i=t.split(`
`);this.output.write(i[e]),this._prevFrame=t,this.output.write(h.move(0,i.length-e-1));return}else if(s&&s?.length>1){const e=s[0];this.output.write(h.move(0,e)),this.output.write(c.down());const r=t.split(`
`).slice(e);this.output.write(r.join(`
`)),this._prevFrame=t;return}this.output.write(c.down())}this.output.write(t),this.state==="initial"&&(this.state="active"),this._prevFrame=t}}}class V extends u{get cursor(){return this.value?0:1}get _value(){return this.cursor===0}constructor(t){super(t,!1),this.value=!!t.initialValue,this.on("value",()=>{this.value=this._value}),this.on("confirm",s=>{this.output.write(h.move(0,-1)),this.value=s,this.state="submit",this.close()}),this.on("cursor",()=>{this.value=!this.value})}}class L extends u{constructor(t){super(t,!1),this.cursor=0;const{options:s}=t;this.options=Object.entries(s).flatMap(([e,i])=>[{value:e,group:!0,label:e},...i.map(r=>({...r,group:e}))]),this.value=[...t.initialValues??[]],this.cursor=Math.max(this.options.findIndex(({value:e})=>e===t.cursorAt),0),this.on("cursor",e=>{switch(e){case"left":case"up":this.cursor=this.cursor===0?this.options.length-1:this.cursor-1;break;case"down":case"right":this.cursor=this.cursor===this.options.length-1?0:this.cursor+1;break;case"space":this.toggleValue();break}})}getGroupItems(t){return this.options.filter(s=>s.group===t)}isGroupSelected(t){return this.getGroupItems(t).every(e=>this.value.includes(e.value))}toggleValue(){const t=this.options[this.cursor];if(t.group===!0){const s=t.value,e=this.getGroupItems(s);this.isGroupSelected(s)?this.value=this.value.filter(i=>e.findIndex(r=>r.value===i)===-1):this.value=[...this.value,...e.map(i=>i.value)],this.value=Array.from(new Set(this.value))}else{const s=this.value.includes(t.value);this.value=s?this.value.filter(e=>e!==t.value):[...this.value,t.value]}}}class S extends u{constructor(t){super(t,!1),this.cursor=0,this.options=t.options,this.value=[...t.initialValues??[]],this.cursor=Math.max(this.options.findIndex(({value:s})=>s===t.cursorAt),0),this.on("key",s=>{s==="a"&&this.toggleAll()}),this.on("cursor",s=>{switch(s){case"left":case"up":this.cursor=this.cursor===0?this.options.length-1:this.cursor-1;break;case"down":case"right":this.cursor=this.cursor===this.options.length-1?0:this.cursor+1;break;case"space":this.toggleValue();break}})}get _value(){return this.options[this.cursor].value}toggleAll(){const t=this.value.length===this.options.length;this.value=t?[]:this.options.map(s=>s.value)}toggleValue(){const t=this.value.includes(this._value);this.value=t?this.value.filter(s=>s!==this._value):[...this.value,this._value]}}class M extends u{constructor({mask:t,...s}){super(s),this.valueWithCursor="",this._mask="\u2022",this._mask=t??"\u2022",this.on("finalize",()=>{this.valueWithCursor=this.masked}),this.on("value",()=>{if(this.cursor>=this.value.length)this.valueWithCursor=`${this.masked}${n.inverse(n.hidden("_"))}`;else{const e=this.masked.slice(0,this.cursor),i=this.masked.slice(this.cursor);this.valueWithCursor=`${e}${n.inverse(i[0])}${i.slice(1)}`}})}get cursor(){return this._cursor}get masked(){return this.value.replaceAll(/./g,this._mask)}}class $ extends u{constructor(t){super(t,!1),this.cursor=0,this.options=t.options,this.cursor=this.options.findIndex(({value:s})=>s===t.initialValue),this.cursor===-1&&(this.cursor=0),this.changeValue(),this.on("cursor",s=>{switch(s){case"left":case"up":this.cursor=this.cursor===0?this.options.length-1:this.cursor-1;break;case"down":case"right":this.cursor=this.cursor===this.options.length-1?0:this.cursor+1;break}this.changeValue()})}get _value(){return this.options[this.cursor]}changeValue(){this.value=this._value.value}}class I extends u{constructor(t){super(t,!1),this.cursor=0,this.options=t.options;const s=this.options.map(({value:[e]})=>e?.toLowerCase());this.cursor=Math.max(s.indexOf(t.initialValue),0),this.on("key",e=>{if(!s.includes(e))return;const i=this.options.find(({value:[r]})=>r?.toLowerCase()===e);i&&(this.value=i.value,this.state="submit",this.emit("submit"))})}}class P extends u{constructor(t){super(t),this.valueWithCursor="",this.on("finalize",()=>{this.value||(this.value=t.defaultValue),this.valueWithCursor=this.value}),this.on("value",()=>{if(this.cursor>=this.value.length)this.valueWithCursor=`${this.value}${n.inverse(n.hidden("_"))}`;else{const s=this.value.slice(0,this.cursor),e=this.value.slice(this.cursor);this.valueWithCursor=`${s}${n.inverse(e[0])}${e.slice(1)}`}})}get cursor(){return this._cursor}}function W({input:o=f,output:t=v,overwrite:s=!0,hideCursor:e=!0}={}){const i=a.createInterface({input:o,output:t,prompt:"",tabSize:1});a.emitKeypressEvents(o,i),o.isTTY&&o.setRawMode(!0);const r=(w,{name:p})=>{if(String(w)===""&&process.exit(0),!s)return;let b=p==="return"?0:-1,_=p==="return"?-1:0;a.moveCursor(t,b,_,()=>{a.clearLine(t,1,()=>{o.once("keypress",r)})})};return e&&process.stdout.write(h.hide),o.once("keypress",r),()=>{o.off("keypress",r),e&&process.stdout.write(h.show),i.terminal=!1,i.close()}}export{V as ConfirmPrompt,L as GroupMultiSelectPrompt,S as MultiSelectPrompt,M as PasswordPrompt,u as Prompt,I as SelectKeyPrompt,$ as SelectPrompt,P as TextPrompt,W as block,C as isCancel};
